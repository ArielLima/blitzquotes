<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Quote</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #F8FAFC 0%, #EFF6FF 100%);
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
      padding: 24px 16px 120px;
    }

    .container { max-width: 640px; margin: 0 auto; }

    /* Document Badge */
    .document-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #3B82F6;
      color: #FFFFFF;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .document-badge.invoice {
      background: #8B5CF6;
    }

    /* Top bar with badge and download button */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .download-button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #FFFFFF;
      color: #475569;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid #E2E8F0;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .download-button:hover {
      background: #F8FAFC;
      border-color: #CBD5E1;
      color: #1E293B;
    }

    .download-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .download-button svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .document-badge svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    /* Header Card */
    .header {
      background: #FFFFFF;
      border-radius: 8px;
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
    }

    .business-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .business-logo {
      width: 125px;
      height: 125px;
      object-fit: cover;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      flex-shrink: 0;
    }

    .business-info {
      flex: 1;
      min-width: 0;
    }

    .business-name {
      font-size: 22px;
      font-weight: 700;
      color: #0F172A;
      margin-bottom: 10px;
      letter-spacing: -0.3px;
    }

    .business-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .business-detail-row {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64748B;
      font-size: 14px;
    }

    .business-detail-row svg {
      width: 14px;
      height: 14px;
      fill: #94A3B8;
      flex-shrink: 0;
    }

    .business-address-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      color: #64748B;
      font-size: 14px;
      margin-top: 20px;
    }

    .business-address-row svg {
      width: 14px;
      height: 14px;
      fill: #94A3B8;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .business-address-row span {
      flex: 1;
      line-height: 1.4;
    }

    .divider {
      height: 1px;
      background: #E2E8F0;
      margin: 20px 0;
    }

    /* Customer Section */
    .customer-section {
      background: #F8FAFC;
      border-radius: 8px;
      padding: 16px;
    }

    .info-block-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94A3B8;
      margin-bottom: 6px;
    }

    .info-block-value {
      font-size: 15px;
      font-weight: 500;
      color: #1E293B;
    }

    .info-block-subvalue {
      font-size: 13px;
      color: #64748B;
      margin-top: 4px;
    }

    /* Date Pills */
    .date-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }

    .date-pills:empty {
      display: none;
    }

    .date-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #F1F5F9;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: #475569;
    }

    .date-pill svg {
      width: 14px;
      height: 14px;
      fill: #64748B;
    }

    .date-pill.due {
      background: #FEF3C7;
      color: #92400E;
    }

    .date-pill.due svg {
      fill: #D97706;
    }

    /* Section Header */
    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin: 24px 0 12px 4px;
    }

    .section-header::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #E2E8F0;
    }

    /* Line Items */
    .line-items-card {
      background: #FFFFFF;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
    }

    .line-item {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #F1F5F9;
    }

    .line-item:last-child {
      border-bottom: none;
    }

    .line-item-info {
      display: flex;
      flex-direction: column;
      flex: 1;
      padding-right: 16px;
    }

    .line-item-name {
      font-weight: 500;
      color: #1E293B;
      margin-bottom: 2px;
    }

    .line-item-qty {
      font-size: 13px;
      color: #94A3B8;
    }

    .line-item-total {
      font-weight: 600;
      font-size: 15px;
      color: #1E293B;
      white-space: nowrap;
    }

    /* Totals */
    .totals {
      background: #FFFFFF;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 15px;
    }

    .totals-label {
      color: #64748B;
    }

    .totals-value {
      font-weight: 500;
      color: #1E293B;
    }

    .total-row {
      margin-top: 12px;
      padding-top: 16px;
      border-top: 2px solid #E2E8F0;
    }

    .total-label {
      font-size: 16px;
      font-weight: 600;
      color: #1E293B;
    }

    .total-value {
      font-size: 24px;
      font-weight: 700;
      color: #3B82F6;
    }

    /* Notes */
    .notes {
      background: #FFFBEB;
      border-radius: 8px;
      padding: 16px 20px;
      border-left: 4px solid #F59E0B;
    }

    .notes-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #D97706;
      margin-bottom: 8px;
    }

    .notes-text {
      color: #78350F;
      font-size: 14px;
      line-height: 1.7;
    }

    /* Payment Section */
    .payment-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #FFFFFF;
      padding: 16px 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      box-shadow: 0 -8px 30px rgba(0,0,0,0.12);
      border-top: 1px solid #E2E8F0;
    }

    .action-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 16px 24px;
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: #FFFFFF;
      text-align: center;
      text-decoration: none;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }

    .action-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    .action-button:active {
      transform: translateY(0);
    }

    .action-button.approve {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
      box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4);
    }

    .action-button.approve:hover {
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
    }

    .action-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .action-button svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    .status-banner {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
    }

    .status-banner svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .status-banner.approved {
      background: linear-gradient(135deg, #F3E8FF 0%, #EDE9FE 100%);
      color: #7C3AED;
    }

    .status-banner.paid {
      background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
      color: #059669;
    }

    .zelle-info {
      max-width: 640px;
      margin: 0 auto;
      text-align: center;
      padding: 8px 16px;
    }

    .zelle-info p {
      margin-bottom: 4px;
      color: #64748B;
    }

    .zelle-info strong {
      color: #1E293B;
    }

    .zelle-details {
      font-size: 20px;
      font-weight: 700;
      color: #3B82F6;
      margin-top: 8px;
    }

    /* Photos Grid */
    .photos-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .photo-item {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .photo-item:hover {
      transform: scale(1.05);
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Photo Lightbox */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .lightbox img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
    }

    /* Loading & Error */
    .loading {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E2E8F0;
      border-top-color: #3B82F6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #64748B;
      font-size: 14px;
    }

    .error {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      text-align: center;
    }

    .error-content {
      background: #FFFFFF;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    .error-icon {
      width: 64px;
      height: 64px;
      background: #FEE2E2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .error-icon svg {
      width: 32px;
      height: 32px;
      fill: #DC2626;
    }

    .error-content h1 {
      color: #1E293B;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .error-content p {
      color: #64748B;
      font-size: 14px;
    }

    .hidden { display: none !important; }

    /* Powered by footer */
    .powered-by {
      text-align: center;
      margin-top: 32px;
      padding-bottom: 20px;
      font-size: 12px;
      color: #94A3B8;
    }

    .powered-by a {
      color: #64748B;
      text-decoration: none;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div class="loading-text">Loading document...</div>
  </div>

  <div id="error" class="error hidden">
    <div class="error-content">
      <div class="error-icon">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
      </div>
      <h1>Document Not Found</h1>
      <p>This quote or invoice may have expired or been removed.</p>
    </div>
  </div>

  <div id="content" class="container hidden">
    <div class="top-bar">
      <div id="documentBadge" class="document-badge">
        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
        <span id="documentType">Quote</span>
      </div>
      <button id="downloadPdfBtn" class="download-button" onclick="downloadPDF()">
        <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        <span>Download PDF</span>
      </button>
    </div>

    <div class="header">
      <div class="business-section">
        <img id="businessLogo" class="business-logo" style="display: none;" alt="Business logo" />
        <div class="business-info">
          <div class="business-name" id="businessName"></div>
          <div class="business-details">
            <div class="business-detail-row" id="phoneRow" style="display: none;">
              <svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
              <span id="businessPhone"></span>
            </div>
            <div class="business-detail-row" id="emailRow" style="display: none;">
              <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              <span id="businessEmail"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="business-address-row" id="addressRow" style="display: none;">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        <span id="businessAddress"></span>
      </div>

      <div class="divider"></div>

      <div class="customer-section">
        <div class="info-block-label">Prepared For</div>
        <div class="info-block-value" id="customerName"></div>
        <div class="info-block-subvalue" id="jobDescription"></div>
        <div class="info-block-subvalue job-address" id="jobAddress" style="display: none;">
          <svg viewBox="0 0 24 24" style="width: 12px; height: 12px; fill: #94A3B8; vertical-align: middle; margin-right: 4px;"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
          <span id="jobAddressText"></span>
        </div>
      </div>

      <div class="date-pills" id="datePills"></div>
    </div>

    <div class="section-header">Line Items</div>
    <div class="line-items-card" id="lineItems"></div>

    <div id="laborSection" class="hidden">
      <div class="section-header">Labor</div>
      <div class="line-items-card">
        <div class="line-item" id="laborItem"></div>
      </div>
    </div>

    <div class="totals">
      <div class="totals-row" id="subtotalRow">
        <span class="totals-label">Subtotal</span>
        <span class="totals-value" id="subtotal"></span>
      </div>
      <div class="totals-row" id="taxRow">
        <span class="totals-label" id="taxLabel"></span>
        <span class="totals-value" id="taxAmount"></span>
      </div>
      <div class="totals-row total-row">
        <span class="total-label">Total Due</span>
        <span class="total-value" id="total"></span>
      </div>
    </div>

    <div id="notesSection" class="hidden" style="margin-top: 20px;">
      <div class="notes">
        <div class="notes-label">Notes</div>
        <div class="notes-text" id="notes"></div>
      </div>
    </div>

    <div id="photosSection" class="hidden">
      <div class="section-header">Photos</div>
      <div class="photos-grid" id="photosGrid"></div>
    </div>

    <div id="lightbox" class="lightbox hidden" onclick="closeLightbox()">
      <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
      <img id="lightboxImage" src="" alt="Photo" onclick="event.stopPropagation()" />
    </div>

    <div class="powered-by">
      Powered by <a href="https://blitzquotes.com">BlitzQuotes</a>
    </div>

    <div id="paymentSection" class="payment-section hidden"></div>
  </div>

  <script>
    const API_URL = 'https://xtbbueuadynxetullmsq.supabase.co/functions/v1/quote-view';
    let currentQuoteId = null;

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatFullDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    async function loadQuote() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      currentQuoteId = id;

      if (!id) { showError(); return; }

      try {
        const response = await fetch(`${API_URL}?id=${id}`);
        if (!response.ok) { showError(); return; }

        const data = await response.json();
        if (data.error) { showError(); return; }
        renderQuote(data);
      } catch (error) {
        console.error('Error:', error);
        showError();
      }
    }

    function showError() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
    }

    async function approveQuote() {
      const button = document.getElementById('approveButton');
      if (button) {
        button.disabled = true;
        button.innerHTML = '<span>Approving...</span>';
      }

      try {
        const response = await fetch(`${API_URL}?id=${currentQuoteId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'approve' }),
        });

        if (response.ok) {
          const section = document.getElementById('paymentSection');
          section.innerHTML = `
            <div class="status-banner approved">
              <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
              <span>Quote Approved</span>
            </div>
          `;
        } else {
          if (button) {
            button.disabled = false;
            button.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>Approve Quote</span>';
          }
          alert('Failed to approve quote. Please try again.');
        }
      } catch (error) {
        console.error('Error:', error);
        if (button) {
          button.disabled = false;
          button.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg><span>Approve Quote</span>';
        }
        alert('Failed to approve quote. Please try again.');
      }
    }

    function renderQuote(data) {
      quoteData = data; // Store for PDF generation
      const { quote, business, payment, canApprove } = data;

      const isInvoice = quote.type === 'invoice';
      const docType = isInvoice ? `Invoice ${quote.invoice_number || ''}` : 'Quote';

      document.title = `${docType} - ${business.name}`;

      // Document badge
      const badge = document.getElementById('documentBadge');
      document.getElementById('documentType').textContent = docType;
      if (isInvoice) {
        badge.classList.add('invoice');
      }

      // Business info
      document.getElementById('businessName').textContent = business.name;

      if (business.logo_url) {
        const logo = document.getElementById('businessLogo');
        logo.src = business.logo_url;
        logo.style.display = 'block';
      }

      if (business.phone) {
        document.getElementById('businessPhone').textContent = business.phone;
        document.getElementById('phoneRow').style.display = 'flex';
      }

      if (business.email) {
        document.getElementById('businessEmail').textContent = business.email;
        document.getElementById('emailRow').style.display = 'flex';
      }

      if (business.address) {
        document.getElementById('businessAddress').textContent = business.address;
        document.getElementById('addressRow').style.display = 'flex';
      }

      // Customer info
      document.getElementById('customerName').textContent = quote.customer_name;
      document.getElementById('jobDescription').textContent = quote.job_description || '';

      if (quote.job_address) {
        document.getElementById('jobAddressText').textContent = quote.job_address;
        document.getElementById('jobAddress').style.display = 'block';
      }

      // Date pills
      const datePills = document.getElementById('datePills');
      let pillsHtml = '';

      if (!isInvoice && quote.valid_until) {
        pillsHtml += `
          <div class="date-pill">
            <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/></svg>
            Valid until ${formatDate(quote.valid_until)}
          </div>
        `;
      }

      if (isInvoice && quote.work_date) {
        pillsHtml += `
          <div class="date-pill">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            Work completed ${formatDate(quote.work_date)}
          </div>
        `;
      }

      if (isInvoice && quote.due_date) {
        pillsHtml += `
          <div class="date-pill due">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            Due ${formatDate(quote.due_date)}
          </div>
        `;
      }

      datePills.innerHTML = pillsHtml;

      // Line items
      document.getElementById('lineItems').innerHTML = quote.line_items.map(item => `
        <div class="line-item">
          <div class="line-item-info">
            <span class="line-item-name">${escapeHtml(item.name)}</span>
            <span class="line-item-qty">${item.qty} ${escapeHtml(item.unit)} @ ${formatCurrency(item.unit_price)}</span>
          </div>
          <span class="line-item-total">${formatCurrency(item.total)}</span>
        </div>
      `).join('');

      // Labor
      if (quote.labor_hours > 0) {
        document.getElementById('laborItem').innerHTML = `
          <div class="line-item-info">
            <span class="line-item-name">Labor</span>
            <span class="line-item-qty">${quote.labor_hours} hrs @ ${formatCurrency(quote.labor_rate)}/hr</span>
          </div>
          <span class="line-item-total">${formatCurrency(quote.labor_total)}</span>
        `;
        document.getElementById('laborSection').classList.remove('hidden');
      }

      // Totals - only show subtotal if there's tax
      if (quote.tax > 0) {
        document.getElementById('subtotal').textContent = formatCurrency(quote.subtotal);
        document.getElementById('taxLabel').textContent = `Tax (${(quote.tax_rate * 100).toFixed(1)}%)`;
        document.getElementById('taxAmount').textContent = formatCurrency(quote.tax);
      } else {
        document.getElementById('subtotalRow').classList.add('hidden');
        document.getElementById('taxRow').classList.add('hidden');
      }

      document.getElementById('total').textContent = formatCurrency(quote.total);

      // Notes
      if (quote.notes) {
        document.getElementById('notes').textContent = quote.notes;
        document.getElementById('notesSection').classList.remove('hidden');
      }

      // Photos
      if (quote.attachments && quote.attachments.length > 0) {
        const photosGrid = document.getElementById('photosGrid');
        photosGrid.innerHTML = quote.attachments.map(attachment => `
          <div class="photo-item" onclick="openLightbox('${escapeHtml(attachment.url)}')">
            <img src="${escapeHtml(attachment.url)}" alt="Photo attachment" loading="lazy" />
          </div>
        `).join('');
        document.getElementById('photosSection').classList.remove('hidden');
      }

      // Payment section
      const section = document.getElementById('paymentSection');

      if (quote.status === 'approved') {
        section.innerHTML = `
          <div class="status-banner approved">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            <span>Quote Approved</span>
          </div>
        `;
        section.classList.remove('hidden');
      } else if (quote.status === 'paid') {
        section.innerHTML = `
          <div class="status-banner paid">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            <span>Paid - Thank You!</span>
          </div>
        `;
        section.classList.remove('hidden');
      } else if (canApprove) {
        section.innerHTML = `
          <button id="approveButton" class="action-button approve" onclick="approveQuote()">
            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            <span>Approve Quote</span>
          </button>
        `;
        section.classList.remove('hidden');
      } else if (payment) {
        if (payment.url) {
          section.innerHTML = `
            <a href="${escapeHtml(payment.url)}" class="action-button" target="_blank">
              <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
              <span>${escapeHtml(payment.label)}</span>
            </a>
          `;
          section.classList.remove('hidden');
        } else if (payment.method === 'zelle') {
          section.innerHTML = `
            <div class="zelle-info">
              <p><strong>Pay with Zelle</strong></p>
              <p>Send ${formatCurrency(quote.total)} to:</p>
              <p class="zelle-details">${escapeHtml(payment.details || '')}</p>
            </div>
          `;
          section.classList.remove('hidden');
        }
      }

      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    }

    // Store quote data for PDF
    let quoteData = null;

    // Lightbox functions
    function openLightbox(imageUrl) {
      document.getElementById('lightboxImage').src = imageUrl;
      document.getElementById('lightbox').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // Close lightbox on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });

    async function downloadPDF() {
      const button = document.getElementById('downloadPdfBtn');
      const originalContent = button.innerHTML;

      button.disabled = true;
      button.innerHTML = `
        <svg viewBox="0 0 24 24" class="spinning"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/></svg>
        <span>Generating...</span>
      `;

      const style = document.createElement('style');
      style.id = 'pdf-spinner-style';
      style.textContent = '@keyframes spin { to { transform: rotate(360deg); } } .spinning { animation: spin 1s linear infinite; }';
      document.head.appendChild(style);

      try {
        if (!quoteData) throw new Error('Quote data not loaded');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        const { quote, business } = quoteData;
        const isInvoice = quote.type === 'invoice';
        const isPaid = quote.status === 'paid';
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        let y = margin;

        // Helper functions
        const formatDatePDF = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr + 'T00:00:00');
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        const formatPhonePDF = (phone) => {
          if (!phone) return '';
          // Keep any leading + and extract digits
          const hasPlus = phone.trim().startsWith('+');
          const digits = phone.replace(/\D/g, '');

          if (digits.length === 10) {
            // US/Canada: (555) 123-4567
            return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
          } else if (digits.length === 11 && digits.startsWith('1')) {
            // US/Canada with country code: +1 (555) 123-4567
            return `+1 (${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`;
          } else if (digits.length === 11 && digits.startsWith('0')) {
            // UK: 020 1234 5678
            return `${digits.slice(0,3)} ${digits.slice(3,7)} ${digits.slice(7)}`;
          } else if (hasPlus && digits.length > 6) {
            // International with +: group as +XX XXX XXX XXXX
            const cc = digits.slice(0, 2);
            const rest = digits.slice(2);
            return `+${cc} ${rest.replace(/(\d{3})(?=\d)/g, '$1 ').trim()}`;
          } else if (digits.length > 6) {
            // Generic: group in threes/fours
            return digits.replace(/(\d{3})(?=\d{4,})/g, '$1 ').replace(/(\d{4})$/, ' $1').trim();
          }
          // Return original if can't format
          return phone;
        };

        // Load logo as base64 if available
        let logoDataUrl = null;
        if (business.logo_url) {
          try {
            const logoResponse = await fetch(business.logo_url);
            const logoBlob = await logoResponse.blob();
            logoDataUrl = await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.readAsDataURL(logoBlob);
            });
          } catch (e) {
            console.warn('Could not load logo:', e);
          }
        }

        // Colors - Construction orange/amber theme
        const accentColor = [234, 88, 12]; // orange-600 - construction orange
        const paidGreen = [22, 163, 74]; // green-600
        const gray = [100, 100, 100];
        const darkGray = [50, 50, 50];
        const lightGray = [150, 150, 150];

        // === HEADER ===
        let headerX = margin;

        // Add logo if available
        if (logoDataUrl) {
          try {
            doc.addImage(logoDataUrl, 'JPEG', margin, y - 5, 18, 18);
            headerX = margin + 22;
          } catch (e) {
            console.warn('Could not add logo to PDF:', e);
          }
        }

        // Business name
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...darkGray);
        doc.text(business.name || 'Business Name', headerX, y);

        // Document type (right side) - smaller, cleaner
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...gray);
        const docTypeText = isInvoice ? 'INVOICE' : 'QUOTE';
        doc.text(docTypeText, pageWidth - margin, y, { align: 'right' });

        y += 5;

        // Invoice number below document type
        if (isInvoice && quote.invoice_number) {
          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...lightGray);
          doc.text(quote.invoice_number, pageWidth - margin, y, { align: 'right' });
        }

        y += 3;

        // Business details
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...gray);
        const businessDetails = [business.address, formatPhonePDF(business.phone), business.email].filter(Boolean);
        if (businessDetails.length > 0) {
          doc.text(businessDetails.join('  •  '), headerX, y);
          y += 4;
        }

        y += 4;

        // Simple divider line
        doc.setDrawColor(220, 220, 220);
        doc.setLineWidth(0.3);
        doc.line(margin, y, pageWidth - margin, y);
        y += 10;

        // === BILL TO & DATE INFO (two columns) ===
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...lightGray);
        doc.text('BILL TO', margin, y);
        doc.text('DATE', pageWidth - margin - 40, y);

        y += 5;

        // Customer name
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...darkGray);
        doc.text(quote.customer_name || 'Customer', margin, y);

        // Date value
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...darkGray);
        const dateStr = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        doc.text(dateStr, pageWidth - margin - 40, y);

        y += 5;

        // Customer contact
        doc.setFontSize(8);
        doc.setTextColor(...gray);
        const customerContact = [formatPhonePDF(quote.customer_phone), quote.customer_email].filter(Boolean).join('  •  ');
        if (customerContact) {
          doc.text(customerContact, margin, y);
          y += 4;
        }

        // Job address
        if (quote.job_address) {
          doc.setFontSize(8);
          doc.setTextColor(...gray);
          doc.text(quote.job_address, margin, y);
          y += 4;
        }

        // Due date or valid until
        if (isInvoice && quote.due_date) {
          doc.setFontSize(8);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...lightGray);
          doc.text('DUE', pageWidth - margin - 40, y);
          y += 4;
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(180, 80, 80);
          doc.text(formatDatePDF(quote.due_date), pageWidth - margin - 40, y);
          y += 4;
        } else if (!isInvoice && quote.valid_until) {
          doc.setFontSize(8);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...lightGray);
          doc.text('VALID UNTIL', pageWidth - margin - 40, y);
          y += 4;
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...gray);
          doc.text(formatDatePDF(quote.valid_until), pageWidth - margin - 40, y);
          y += 4;
        } else {
          y += 8;
        }

        y += 6;

        // === JOB DESCRIPTION ===
        if (quote.job_description) {
          doc.setFontSize(8);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...lightGray);
          doc.text('DESCRIPTION', margin, y);
          y += 4;

          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...darkGray);
          const descLines = doc.splitTextToSize(quote.job_description, contentWidth);
          doc.text(descLines.slice(0, 2).join(' '), margin, y);

          y += 8;
        }

        // === LINE ITEMS TABLE ===
        const colWidths = [contentWidth * 0.5, contentWidth * 0.12, contentWidth * 0.18, contentWidth * 0.20];
        const colX = [margin, margin + colWidths[0], margin + colWidths[0] + colWidths[1], margin + colWidths[0] + colWidths[1] + colWidths[2]];

        // Table header - simple underline style
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...lightGray);
        doc.text('ITEM', colX[0], y);
        doc.text('QTY', colX[1], y);
        doc.text('PRICE', colX[2], y);
        doc.text('AMOUNT', colX[3], y);

        y += 2;
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.line(margin, y, pageWidth - margin, y);
        y += 5;

        // Table rows
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        quote.line_items.forEach((item, index) => {
          doc.setTextColor(...darkGray);
          const nameLines = doc.splitTextToSize(item.name, colWidths[0] - 4);
          doc.text(nameLines[0], colX[0], y);

          doc.setTextColor(...gray);
          doc.text(`${item.qty}`, colX[1], y);
          doc.text(formatCurrency(item.unit_price), colX[2], y);

          doc.setTextColor(...darkGray);
          doc.text(formatCurrency(item.total), colX[3], y);

          y += 6;
        });

        // Add labor row if present
        if (quote.labor_hours > 0) {
          doc.setTextColor(...darkGray);
          doc.text('Labor', colX[0], y);

          doc.setTextColor(...gray);
          doc.text(`${quote.labor_hours} hrs`, colX[1], y);
          doc.text(`${formatCurrency(quote.labor_rate)}/hr`, colX[2], y);

          doc.setTextColor(...darkGray);
          doc.text(formatCurrency(quote.labor_total), colX[3], y);

          y += 6;
        }

        y += 6;

        // === TOTALS ===
        const totalsX = pageWidth - margin - 50;

        if (quote.tax > 0) {
          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...gray);
          doc.text('Subtotal', totalsX, y);
          doc.text(formatCurrency(quote.subtotal), pageWidth - margin, y, { align: 'right' });
          y += 5;

          doc.text(`Tax (${(quote.tax_rate * 100).toFixed(1)}%)`, totalsX, y);
          doc.text(formatCurrency(quote.tax), pageWidth - margin, y, { align: 'right' });
          y += 6;
        }

        // Divider line above total
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.line(totalsX, y, pageWidth - margin, y);
        y += 6;

        // Total row
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...darkGray);

        if (isPaid) {
          doc.text('Total', totalsX, y);
          doc.setFontSize(12);
          doc.text(formatCurrency(quote.total), pageWidth - margin, y, { align: 'right' });

          // Small "PAID" badge
          y += 8;
          doc.setFillColor(220, 252, 231);
          doc.roundedRect(pageWidth - margin - 22, y - 4, 22, 7, 1, 1, 'F');
          doc.setFontSize(7);
          doc.setTextColor(...paidGreen);
          doc.text('PAID', pageWidth - margin - 11, y, { align: 'center' });
        } else {
          doc.text('Total Due', totalsX, y);
          doc.setFontSize(12);
          doc.setTextColor(...darkGray);
          doc.text(formatCurrency(quote.total), pageWidth - margin, y, { align: 'right' });
        }

        y += 16;

        // === NOTES ===
        if (quote.notes) {
          doc.setFontSize(8);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...lightGray);
          doc.text('NOTES', margin, y);
          y += 4;

          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...gray);
          const noteLines = doc.splitTextToSize(quote.notes, contentWidth);
          doc.text(noteLines.slice(0, 3), margin, y);

          y += noteLines.slice(0, 3).length * 4 + 8;
        }

        // === FOOTER ===
        y += 6;
        doc.setFontSize(8);
        doc.setTextColor(...lightGray);
        doc.text('Thank you for your business', pageWidth / 2, y, { align: 'center' });

        // Save PDF
        const docTypeLabel = isInvoice ? 'Invoice' : 'Quote';
        const customerNameClean = (quote.customer_name || 'Customer').replace(/[^a-zA-Z0-9]/g, '_');
        const invoiceNum = quote.invoice_number ? `_${quote.invoice_number}` : '';
        const filename = `${docTypeLabel}${invoiceNum}_${customerNameClean}.pdf`;

        doc.save(filename);

      } catch (error) {
        console.error('PDF generation error:', error);
        alert('Failed to generate PDF: ' + error.message);
      } finally {
        document.getElementById('pdf-spinner-style')?.remove();
        button.disabled = false;
        button.innerHTML = originalContent;
      }
    }

    loadQuote();
  </script>
</body>
</html>
